from alpha.strategies.twins import Twins
import unittest
import datetime
import numpy as np


class TestTwins(unittest.TestCase):
    def test_xtransform(self):
        """Test xtransform()"""
        bars = np.array(
            [
                (
                    datetime.date(2021, 4, 22),
                    12.51,
                    13.47,
                    12.33,
                    12.66,
                    1.32478221e08,
                    1.70187092e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 4, 23),
                    12.33,
                    13.15,
                    12.33,
                    12.82,
                    1.12274365e08,
                    1.43469683e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 4, 26),
                    12.630001,
                    13.049999,
                    12.31,
                    12.5,
                    8.89036690e07,
                    1.12385162e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 4, 27),
                    12.47,
                    12.51,
                    11.67,
                    12.02,
                    8.06145950e07,
                    9.68163907e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 4, 28),
                    12.1,
                    12.65,
                    11.84,
                    12.2,
                    7.39603330e07,
                    9.09436321e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 4, 29),
                    12.19,
                    12.67,
                    11.85,
                    12.33,
                    9.08868650e07,
                    1.11566305e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 4, 30),
                    12.24,
                    13.45,
                    12.01,
                    13.07,
                    1.29319774e08,
                    1.66276482e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 6),
                    13.190001,
                    14.379999,
                    12.83,
                    14.379999,
                    1.84156366e08,
                    2.52096315e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 7),
                    14.199999,
                    14.81,
                    13.950001,
                    14.11,
                    1.49818951e08,
                    2.15484067e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 10),
                    14.0,
                    15.52,
                    13.960001,
                    15.39,
                    1.54944791e08,
                    2.33246472e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 11),
                    14.93,
                    14.93,
                    13.85,
                    14.260001,
                    1.42788837e08,
                    2.04636956e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 12),
                    14.51,
                    14.98,
                    14.0,
                    14.69,
                    9.68123580e07,
                    1.40875829e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 13),
                    14.089999,
                    14.86,
                    13.85,
                    14.44,
                    8.63558370e07,
                    1.23644198e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 14),
                    14.42,
                    15.49,
                    14.06,
                    15.21,
                    1.19430215e08,
                    1.78212210e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 17),
                    15.04,
                    15.860001,
                    14.649999,
                    14.75,
                    1.17258255e08,
                    1.77274258e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 18),
                    14.8,
                    15.710001,
                    14.8,
                    15.549999,
                    1.16504868e08,
                    1.78911418e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 19),
                    15.2,
                    17.0,
                    15.05,
                    16.3,
                    1.36611976e08,
                    2.18994981e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 20),
                    15.9800005,
                    16.35,
                    15.590001,
                    15.95,
                    8.66828140e07,
                    1.38511300e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 21),
                    15.81,
                    16.5,
                    15.36,
                    16.28,
                    9.39778980e07,
                    1.50005066e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 24),
                    15.999999,
                    16.59,
                    15.63,
                    15.91,
                    6.75772130e07,
                    1.08345729e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 25),
                    15.75,
                    15.870001,
                    14.830001,
                    15.19,
                    9.97419860e07,
                    1.52175525e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 26),
                    15.09,
                    15.47,
                    15.01,
                    15.16,
                    5.65818810e07,
                    8.61576384e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 27),
                    15.06,
                    15.259999,
                    14.71,
                    14.820001,
                    6.39138540e07,
                    9.55640252e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 28),
                    14.820001,
                    15.549999,
                    14.820001,
                    15.140001,
                    7.93977190e07,
                    1.21104048e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 5, 31),
                    15.1,
                    15.829999,
                    15.0,
                    15.710001,
                    8.70966560e07,
                    1.35442079e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 1),
                    15.400001,
                    15.46,
                    14.62,
                    14.969999,
                    7.99498920e07,
                    1.20292703e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 2),
                    14.850001,
                    15.35,
                    14.28,
                    14.42,
                    7.11406210e07,
                    1.05658749e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 3),
                    14.189999,
                    14.5,
                    13.780001,
                    14.15,
                    6.07800110e07,
                    8.59849175e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 4),
                    13.909999,
                    14.8,
                    13.82,
                    14.47,
                    7.55601780e07,
                    1.09157053e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 7),
                    14.479999,
                    14.75,
                    14.17,
                    14.31,
                    5.47453010e07,
                    7.89048181e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 8),
                    14.14,
                    14.62,
                    13.56,
                    13.780001,
                    6.27773760e07,
                    8.77746716e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 9),
                    13.790001,
                    13.940001,
                    13.41,
                    13.86,
                    4.45542160e07,
                    6.11943565e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 10),
                    13.909999,
                    14.35,
                    13.75,
                    14.0,
                    6.32876720e07,
                    8.92024208e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 11),
                    13.88,
                    14.089999,
                    13.45,
                    14.03,
                    5.37204610e07,
                    7.38291730e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 15),
                    13.970001,
                    14.12,
                    13.190001,
                    13.28,
                    5.25348460e07,
                    7.10342299e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 16),
                    13.12,
                    13.380001,
                    12.25,
                    12.38,
                    5.48829170e07,
                    6.96822247e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 17),
                    12.48,
                    12.81,
                    12.42,
                    12.620001,
                    3.81796280e07,
                    4.82391235e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 18),
                    12.5,
                    13.17,
                    12.38,
                    12.99,
                    5.28999580e07,
                    6.80331492e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 21),
                    12.83,
                    13.44,
                    12.739999,
                    13.07,
                    4.27635610e07,
                    5.62362366e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 22),
                    13.349999,
                    13.36,
                    12.910001,
                    13.18,
                    3.45550530e07,
                    4.54753352e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 23),
                    13.15,
                    13.85,
                    13.0,
                    13.59,
                    6.07116440e07,
                    8.19809938e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 24),
                    13.510001,
                    13.69,
                    13.16,
                    13.16,
                    3.80425240e07,
                    5.08932246e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 25),
                    13.15,
                    13.339999,
                    13.049999,
                    13.190001,
                    2.68785520e07,
                    3.54374677e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 28),
                    13.25,
                    13.609999,
                    13.11,
                    13.47,
                    3.10916940e07,
                    4.18690647e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 29),
                    13.57,
                    14.02,
                    13.319999,
                    13.65,
                    5.17816780e07,
                    7.11463135e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 6, 30),
                    13.4800005,
                    13.950001,
                    13.390001,
                    13.809999,
                    4.69379890e07,
                    6.44370710e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 1),
                    13.799999,
                    13.899999,
                    13.13,
                    13.29,
                    4.66654000e07,
                    6.27786496e08,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 2),
                    13.28,
                    14.3,
                    13.11,
                    14.079999,
                    8.59166350e07,
                    1.19292240e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 5),
                    14.47,
                    15.410001,
                    14.22,
                    15.15,
                    1.07446518e08,
                    1.60942731e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 6),
                    15.01,
                    15.06,
                    13.950001,
                    14.359999,
                    1.00038742e08,
                    1.45680079e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 7),
                    14.05,
                    15.75,
                    13.72,
                    15.140001,
                    1.13910483e08,
                    1.70636990e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 8),
                    15.16,
                    15.719999,
                    15.0,
                    15.19,
                    9.17859520e07,
                    1.40484525e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 9),
                    14.86,
                    16.28,
                    14.73,
                    15.93,
                    1.38613519e08,
                    2.18458769e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 12),
                    16.2,
                    17.52,
                    16.19,
                    17.21,
                    1.82963112e08,
                    3.11261187e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 13),
                    16.93,
                    18.93,
                    16.7,
                    18.93,
                    2.01945896e08,
                    3.60314930e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 14),
                    18.8,
                    18.82,
                    17.04,
                    17.46,
                    1.82801483e08,
                    3.25120759e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 15),
                    17.03,
                    18.2,
                    16.58,
                    17.87,
                    1.42255603e08,
                    2.47378403e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 16),
                    17.7,
                    19.55,
                    17.53,
                    18.21,
                    1.43700758e08,
                    2.68983607e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 19),
                    17.81,
                    18.88,
                    17.0,
                    17.29,
                    1.38828512e08,
                    2.48077103e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 20),
                    17.09,
                    19.02,
                    17.01,
                    19.02,
                    1.93590543e08,
                    3.62672555e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 21),
                    19.65,
                    20.69,
                    19.26,
                    20.35,
                    1.99581365e08,
                    4.00214060e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 22),
                    20.81,
                    21.4,
                    20.35,
                    21.02,
                    1.62128477e08,
                    3.38019461e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 23),
                    20.55,
                    22.24,
                    20.11,
                    21.16,
                    1.37576029e08,
                    2.91085642e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 26),
                    21.45,
                    22.1,
                    20.17,
                    21.77,
                    1.24216973e08,
                    2.62813034e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 27),
                    21.52,
                    22.6,
                    19.59,
                    19.59,
                    1.58469452e08,
                    3.33606838e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 28),
                    18.4,
                    19.5,
                    17.64,
                    18.75,
                    1.05644326e08,
                    1.97370327e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 29),
                    19.49,
                    20.34,
                    19.02,
                    19.58,
                    1.11395167e08,
                    2.19003339e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 7, 30),
                    20.33,
                    21.3,
                    19.8,
                    20.89,
                    1.32317095e08,
                    2.72622427e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 2),
                    21.4,
                    22.2,
                    19.95,
                    20.8,
                    1.28755017e08,
                    2.72689112e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 3),
                    20.42,
                    21.56,
                    19.58,
                    20.0,
                    9.09857710e07,
                    1.86430388e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 4),
                    19.92,
                    22.0,
                    19.78,
                    22.0,
                    1.17791148e08,
                    2.49084414e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 5),
                    22.57,
                    24.2,
                    21.88,
                    24.2,
                    1.62183905e08,
                    3.75691844e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 6),
                    25.4,
                    26.200003,
                    24.59,
                    25.410002,
                    1.27219394e08,
                    3.22256012e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 9),
                    25.3,
                    25.47,
                    22.9,
                    24.03,
                    1.24367558e08,
                    2.95601023e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 10),
                    23.62,
                    25.459997,
                    22.59,
                    24.93,
                    1.31672908e08,
                    3.17283593e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 11),
                    24.33,
                    26.86,
                    24.18,
                    26.17,
                    1.29914964e08,
                    3.30924261e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 12),
                    25.519999,
                    26.36,
                    24.45,
                    25.57,
                    9.00569440e07,
                    2.28286632e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 13),
                    24.6,
                    28.13,
                    24.5,
                    27.5,
                    1.59924248e08,
                    4.38541704e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 16),
                    27.020002,
                    27.170002,
                    24.78,
                    24.94,
                    1.29004010e08,
                    3.32935698e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 17),
                    24.46,
                    25.23,
                    23.42,
                    23.9,
                    8.91739950e07,
                    2.16857829e09,
                    1.57,
                ),
                (
                    datetime.date(2021, 8, 18),
                    23.92,
                    24.85,
                    23.2,
                    24.15,
                    7.29078920e07,
                    1.75545000e09,
                    1.57,
                ),
            ],
            dtype=[
                ("frame", "O"),
                ("open", "<f4"),
                ("high", "<f4"),
                ("low", "<f4"),
                ("close", "<f4"),
                ("volume", "<f8"),
                ("amount", "<f8"),
                ("factor", "<f4"),
            ],
        )

        twins = Twins("test")
        # this is temporay hack, to correct the issue with previous dumped data
        twins.day_morph.flen = 20

        vec = twins.x_transform(bars)
        print(twins._describe_vec(vec))
