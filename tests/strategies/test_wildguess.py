import datetime
import unittest

import arrow
import cfg4py
import numpy as np
import omicron
from dateutil.tz import tzfile

from alpha.config import get_config_dir
from alpha.core.features import predict_by_moving_average
from alpha.strategies.wildguess import WildGuess


class TestWildGuess(unittest.IsolatedAsyncioTestCase):
    async def asyncSetUp(self):
        cfg4py.init(get_config_dir())
        await omicron.init()

    async def test_scan(self):
        guess = WildGuess()
        df = await guess.scan(frame_type="30m")
        self.assertEqual(1, len(df))

    def test_volume_features(self):
        guess = WildGuess()

        # 600163.XSHG 2021-09-02 11:30
        bars = np.array(
            [
                (
                    datetime.datetime(
                        2021,
                        8,
                        24,
                        10,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.46,
                    5.5899997,
                    5.45,
                    5.51,
                    5300800.0,
                    29286870.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        24,
                        10,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.51,
                    5.52,
                    5.46,
                    5.48,
                    1754100.0,
                    9617812.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        24,
                        11,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.48,
                    5.4900002,
                    5.45,
                    5.46,
                    1476400.0,
                    8072225.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        24,
                        11,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.46,
                    5.48,
                    5.42,
                    5.46,
                    1401600.0,
                    7645669.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        24,
                        13,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.45,
                    5.48,
                    5.44,
                    5.47,
                    1527800.0,
                    8333453.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        24,
                        14,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.47,
                    5.47,
                    5.43,
                    5.45,
                    900100.0,
                    4909483.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        24,
                        14,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.45,
                    5.45,
                    5.42,
                    5.43,
                    1442900.0,
                    7840157.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        24,
                        15,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.43,
                    5.47,
                    5.43,
                    5.47,
                    2738600.0,
                    14939945.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        25,
                        10,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.45,
                    5.47,
                    5.3899994,
                    5.42,
                    2404000.0,
                    13035368.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        25,
                        10,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.42,
                    5.45,
                    5.4,
                    5.43,
                    1333100.0,
                    7231709.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        25,
                        11,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.43,
                    5.46,
                    5.42,
                    5.45,
                    1157400.0,
                    6294840.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        25,
                        11,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.45,
                    5.52,
                    5.44,
                    5.5,
                    2066200.0,
                    11327128.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        25,
                        13,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.5,
                    5.53,
                    5.48,
                    5.5,
                    2147300.0,
                    11825561.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        25,
                        14,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.4900002,
                    5.4900002,
                    5.46,
                    5.4900002,
                    931200.0,
                    5101482.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        25,
                        14,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.48,
                    5.51,
                    5.48,
                    5.4900002,
                    1584800.0,
                    8710840.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        25,
                        15,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.4900002,
                    5.52,
                    5.48,
                    5.52,
                    2482400.0,
                    13662770.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        26,
                        10,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.55,
                    5.5899997,
                    5.4900002,
                    5.52,
                    4202600.0,
                    23305783.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        26,
                        10,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.52,
                    5.5399995,
                    5.5,
                    5.53,
                    1260500.0,
                    6952825.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        26,
                        11,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.53,
                    5.5399995,
                    5.52,
                    5.52,
                    719700.0,
                    3979330.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        26,
                        11,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.52,
                    5.61,
                    5.52,
                    5.6,
                    3514000.0,
                    19560768.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        26,
                        13,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.5899997,
                    5.61,
                    5.52,
                    5.55,
                    2773900.0,
                    15434310.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        26,
                        14,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.5399995,
                    5.56,
                    5.52,
                    5.55,
                    1534200.0,
                    8493824.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        26,
                        14,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.5399995,
                    5.56,
                    5.52,
                    5.5399995,
                    1797600.0,
                    9944286.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        26,
                        15,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.53,
                    5.55,
                    5.51,
                    5.53,
                    3692600.0,
                    20407714.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        27,
                        10,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.5899997,
                    5.61,
                    5.52,
                    5.53,
                    3934100.0,
                    21869799.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        27,
                        10,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.5399995,
                    5.55,
                    5.48,
                    5.48,
                    2360600.0,
                    12988322.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        27,
                        11,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.48,
                    5.53,
                    5.48,
                    5.53,
                    1347100.0,
                    7416551.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        27,
                        11,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.53,
                    5.55,
                    5.52,
                    5.55,
                    1258900.0,
                    6970574.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        27,
                        13,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.55,
                    5.56,
                    5.53,
                    5.55,
                    1059300.0,
                    5873305.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        27,
                        14,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.55,
                    5.55,
                    5.51,
                    5.52,
                    1394600.0,
                    7711333.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        27,
                        14,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.53,
                    5.6,
                    5.52,
                    5.57,
                    2511400.0,
                    13974922.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        27,
                        15,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.58,
                    5.6,
                    5.55,
                    5.6,
                    3924300.0,
                    21925921.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        30,
                        10,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.5899997,
                    5.61,
                    5.44,
                    5.5899997,
                    6889200.0,
                    38060414.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        30,
                        10,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.6,
                    5.66,
                    5.58,
                    5.61,
                    3522300.0,
                    19797907.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        30,
                        11,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.61,
                    5.74,
                    5.6,
                    5.6400003,
                    5035800.0,
                    28526694.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        30,
                        11,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.6400003,
                    5.65,
                    5.5899997,
                    5.62,
                    1619200.0,
                    9106624.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        30,
                        13,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.61,
                    5.75,
                    5.61,
                    5.73,
                    2585500.0,
                    14684228.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        30,
                        14,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.73,
                    5.73,
                    5.61,
                    5.61,
                    2138000.0,
                    12091324.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        30,
                        14,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.61,
                    5.65,
                    5.6,
                    5.62,
                    1597900.0,
                    8981405.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        30,
                        15,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.62,
                    5.68,
                    5.6,
                    5.65,
                    5311300.0,
                    30023132.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        31,
                        10,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.66,
                    5.66,
                    5.55,
                    5.55,
                    4669600.0,
                    26118053.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        31,
                        10,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.55,
                    5.6900005,
                    5.53,
                    5.68,
                    3212400.0,
                    17968149.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        31,
                        11,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.68,
                    5.72,
                    5.61,
                    5.62,
                    2650800.0,
                    15063591.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        31,
                        11,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.62,
                    5.62,
                    5.58,
                    5.6,
                    1050000.0,
                    5874503.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        31,
                        13,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.6,
                    5.66,
                    5.58,
                    5.63,
                    1672300.0,
                    9411796.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        31,
                        14,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.63,
                    5.71,
                    5.63,
                    5.6900005,
                    2141700.0,
                    12150805.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        31,
                        14,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.6900005,
                    5.71,
                    5.66,
                    5.71,
                    2946000.0,
                    16756839.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        8,
                        31,
                        15,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.7,
                    5.71,
                    5.63,
                    5.65,
                    4776200.0,
                    27036625.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        1,
                        10,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.6900005,
                    5.93,
                    5.65,
                    5.8099995,
                    11231400.0,
                    65504766.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        1,
                        10,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.8099995,
                    5.83,
                    5.65,
                    5.72,
                    6013600.0,
                    34434877.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        1,
                        11,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.72,
                    5.74,
                    5.5,
                    5.61,
                    6753800.0,
                    37871375.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        1,
                        11,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.62,
                    5.6900005,
                    5.5899997,
                    5.62,
                    2434500.0,
                    13724468.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        1,
                        13,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.63,
                    5.76,
                    5.63,
                    5.71,
                    5078400.0,
                    28906977.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        1,
                        14,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.7,
                    5.79,
                    5.63,
                    5.79,
                    4571400.0,
                    26181890.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        1,
                        14,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.79,
                    5.86,
                    5.75,
                    5.82,
                    4766500.0,
                    27690079.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        1,
                        15,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.82,
                    5.83,
                    5.74,
                    5.76,
                    4448900.0,
                    25807039.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        2,
                        10,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.76,
                    5.94,
                    5.63,
                    5.94,
                    12006400.0,
                    69975416.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        2,
                        10,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.95,
                    6.0600004,
                    5.89,
                    6.0,
                    13042900.0,
                    78035291.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        2,
                        11,
                        0,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    5.99,
                    6.0600004,
                    5.98,
                    6.05,
                    5927400.0,
                    35724998.0,
                    2.352,
                ),
                (
                    datetime.datetime(
                        2021,
                        9,
                        2,
                        11,
                        30,
                        tzinfo=tzfile("/usr/share/zoneinfo/Asia/Shanghai"),
                    ),
                    6.04,
                    6.15,
                    5.99,
                    6.15,
                    6730000.0,
                    40837283.0,
                    2.352,
                ),
            ],
            dtype=[
                ("frame", "O"),
                ("open", "<f4"),
                ("high", "<f4"),
                ("low", "<f4"),
                ("close", "<f4"),
                ("volume", "<f8"),
                ("amount", "<f8"),
                ("factor", "<f4"),
            ],
        )

        vr = guess.volume_features(bars)
        exp = [-1.0, 1.83, 1.98]
        np.testing.assert_array_almost_equal(exp, vr, 1)
